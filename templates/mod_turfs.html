{% extends "layout.html" %}
{% block title %}Mod Turfs{% endblock %}
{% block head %}
  <style type="text/css">
  .mod-g { color: #2c2; }
  .mod-c { color: #22c; }
  .mod-w { }
  .mod-n { color: #c22; }

  #shows tr:nth-child(odd) { background: #ddd; }
  #shows tr:nth-child(even) { background: #fff; }

  #shows tr.high-posts.no-mods { background: #c22 !important; }

  #shows tr:nth-child(odd).high-posts { background: #bdb; }
  #shows tr:nth-child(even).high-posts { background: #dfd; }

  #shows tr:nth-child(odd).no-mods { background: #dcc; }
  #shows tr:nth-child(even).no-mods { background: #fee; }

  #shows { margin-top: 2em; }
  #shows td { padding: 0 1em; }
  #shows td:first-child { padding-left: 0; }
  #shows td:last-child { padding-right: 0; }
  #shows td.show-name {
    overflow: auto;
    max-width: 15em;
    white-space: nowrap;
  }
  #shows .canceled, #shows .ep-posts, #shows .you {
    white-space: nowrap;
  }
  #shows .me {
    min-width: 15em;
  }
  #shows .tvdb-link {
    font-size: 70%;
  }

  td.post-count { text-align: right; }
  </style>

  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript">
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    // TODO: indicators when ajax is working/successful

    function get_ajax_checkbox_call(thing) {
      return {
        dataType: "json",
        type: "POST",
        data: {
          showid: thing.closest('tr').data('showid'),
          val: thing.is(':checked')
        },
        success: function(data) {
          $(this).val(data.curr);
        },
        error: function(data, status, thrown) { 
          alert("ERROR " + status + ": " + thrown);
        }
      };
    }
    function mark_over_action() {
      $.ajax($SCRIPT_ROOT + '/_mark_over/', get_ajax_checkbox_call($(this)));
    }
    function mark_per_ep_action() {
      $.ajax($SCRIPT_ROOT + '/_mark_per_ep/', get_ajax_checkbox_call($(this)));
    }

    function mod_comments_action() {
      var row = $(this).closest('tr');
      $.ajax($SCRIPT_ROOT + '/_mark_territory/', {
        dataType: "text",
        type: "POST",
        data: {
          showid: row.data('showid'),
          modid: {{ modid }},
          val: row.find('.havingness').val(),
          comments: row.find('.comments').val(),
          hi_post_thresh: {{ hi_post_thresh }}
        },
        success: function(data) {
          var rep = $(data);
          row.replaceWith(rep);
          bind_callbacks(rep);
        },
        error: function(data, status, thrown) { 
          alert("ERROR " + status + ": " + thrown);
        }
      });
    }

    function bind_callbacks(obj) {
      obj.find('.canceled input').on("change", mark_over_action);
      obj.find('.ep-posts input').on("change", mark_per_ep_action);
      obj.find('.havingness').on("change", mod_comments_action);
      obj.find('.comments').on("change", mod_comments_action);
    }

    $(function() { bind_callbacks($(document)); });
  </script>
{% endblock %}
{% block body %}
  <h1>Mod Turfs</h1>

  {% if modname %}
    <p>Hey {{ modname }}!</p>
  {% else %}
    <p>Hey, you! <a href="{{ url_for('mod_turfs_id') }}">Identify yourself!</a> (If you want to be able to claim entries 'n stuff.)</p>
  {% endif %}

  <p>
    {{ no_coverage }} shows aren't claimed by anyone.
  </p>

  <p>
    Edits here take effect immediately, so don't go around just doing stuff. :)
  </p>

  <p>
    Color scheme:
    pinkish background means no mods,
    greenish background means a lot of posts (top 10%, or over {{ hi_post_thresh }}),
    red means both.
    For mod lists,
    <span class="mod-g">got it</span> / <span class="mod-c">can take</span> / <span class="mod-w">I watch</span> / <span class="mod-n">no way</span>.
  </p>

  <table id="shows">
    <thead>
      <tr>
        <th>Show</th>
        <th>Posts</th>
        <th>Over?</th>
        <th>Per-ep posts?</th>
        {% if modname %} <th>You</th> {% endif %}
        <th>Mods</th>
      </tr>
    </thead>
    <tbody>
      {% for show, info in shows %}
        {% include "turf_row.html" %}
      {% endfor %} 
    </tbody>
  </table>
{% endblock %}